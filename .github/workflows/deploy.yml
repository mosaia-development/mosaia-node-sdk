name: Publish to NPM

on:
  push:
    tags:
      - 'v*' # Run workflow on tags starting with 'v'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.17.0'
          registry-url: 'https://registry.npmjs.org'

      # 3. Extract the version from the tag
      - name: Extract version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      # 4. Update the version in package.json
      - name: Update package.json version
        run: |
          VERSION=${{ env.version }}
          echo "Updating package.json to version $VERSION"
          jq '.version = "'$VERSION'"' package.json > tmp.json && mv tmp.json package.json

      # 5. Install dependencies
      - name: Install dependencies
        run: npm install

      # 6. Build the project
      - name: Build project
        run: npm run build

      # 7. Run tests with coverage
      - name: Run tests with coverage
        id: test-run
        run: |
          echo "Running test suite with coverage..."
          echo "Test command: npx jest --coverage --watchAll=false --ci --verbose --json --outputFile=test-results.json --testTimeout=30000"
          
          # Run tests with coverage and JSON output, with increased timeout
          npx jest --coverage --watchAll=false --ci --verbose --json --outputFile=test-results.json --testTimeout=30000
          
          # Check if tests failed
          if [ $? -eq 0 ]; then
            echo "âœ… All tests passed successfully!"
            echo "ðŸ“Š Coverage report generated"
            echo "ðŸ“‹ Test results saved to test-results.json"
          else
            echo "âŒ Some tests failed!"
            echo "ðŸ“Š Coverage report may be incomplete due to test failures"
            echo "ðŸ“‹ Test results saved to test-results.json for analysis"
            exit 1
          fi
          
          echo "Tests completed"

      # 8. Generate TSDoc documentation
      - name: Generate TSDoc documentation
        run: |
          echo "Generating TSDoc documentation..."
          npm run docs
          echo "Documentation generated successfully"
          
          # Verify that TypeDoc generated the index.html file
          if [ ! -f "docs/index.html" ]; then
            echo "âŒ Error: TypeDoc did not generate docs/index.html"
            exit 1
          fi
          echo "âœ… TypeDoc documentation generated successfully in docs/ folder"

      # 9. Checkout gh-pages branch to preserve existing versions
      - name: Checkout gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      # 9.1. Initialize gh-pages if it doesn't exist
      - name: Initialize gh-pages if needed
        if: failure()
        run: |
          mkdir -p gh-pages
          cd gh-pages
          git init
          git checkout -b gh-pages || true
          echo "âœ… Initialized gh-pages directory"

      # 10. Prepare versioned documentation
      - name: Prepare versioned documentation
        run: |
          VERSION=${{ env.version }}
          echo "Preparing documentation for version: $VERSION"
          
          # Create versioned directory in gh-pages workspace
          VERSION_DIR="gh-pages/v$VERSION"
          mkdir -p "$VERSION_DIR"
          
          # Copy documentation files
          cp -r docs/* "$VERSION_DIR/"
          
          echo "âœ… Versioned documentation prepared in $VERSION_DIR/"

      # 11. Generate documentation index page
      - name: Generate documentation index
        run: |
          chmod +x scripts/generate-docs-index.sh
          ./scripts/generate-docs-index.sh gh-pages

      # 12. Deploy versioned documentation to GitHub Pages
      # Note: GitHub Pages must be configured to serve from the 'gh-pages' branch
      # Settings > Pages > Source: Deploy from a branch > Branch: gh-pages / (root)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          publish_branch: gh-pages
          keep_files: false
          force_orphan: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      # 13. Update README with latest version link
      - name: Checkout main branch for README update
        uses: actions/checkout@v3
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          path: main-branch

      - name: Update README with latest version
        run: |
          VERSION=${{ env.version }}
          echo "Updating README.md with version $VERSION"
          
          cd main-branch
          
          # Update the README.md to replace LATEST_VERSION placeholder with actual version
          sed -i "s|vLATEST_VERSION|v$VERSION|g" README.md
          sed -i "s|Latest version: \*\*vLATEST_VERSION\*\*|Latest version: **v$VERSION**|g" README.md
          
          # Check if README was modified
          if git diff --quiet README.md; then
            echo "No changes to README.md"
          else
            echo "README.md updated with version $VERSION"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "docs: Update README with latest release version v$VERSION"
            git push origin main || echo "Failed to push README update"
          fi

      # 14. Publish to NPM
      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
