name: Publish to NPM

on:
  push:
    tags:
      - 'v*' # Run workflow on tags starting with 'v'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.17.0'
          registry-url: 'https://registry.npmjs.org'

      # 3. Extract the version from the tag
      - name: Extract version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      # 4. Update the version in package.json
      - name: Update package.json version
        run: |
          VERSION=${{ env.version }}
          echo "Updating package.json to version $VERSION"
          jq '.version = "'$VERSION'"' package.json > tmp.json && mv tmp.json package.json

      # 5. Install dependencies
      - name: Install dependencies
        run: npm install

      # 6. Build the project
      - name: Build project
        run: npm run build

      # 7. Run tests with coverage
      - name: Run tests with coverage
        id: test-run
        run: |
          echo "Running test suite with coverage..."
          echo "Test command: npx jest --coverage --watchAll=false --ci --verbose --json --outputFile=test-results.json --testTimeout=30000"
          
          # Run tests with coverage and JSON output, with increased timeout
          npx jest --coverage --watchAll=false --ci --verbose --json --outputFile=test-results.json --testTimeout=30000
          
          # Check if tests failed
          if [ $? -eq 0 ]; then
            echo "âœ… All tests passed successfully!"
            echo "ðŸ“Š Coverage report generated"
            echo "ðŸ“‹ Test results saved to test-results.json"
          else
            echo "âŒ Some tests failed!"
            echo "ðŸ“Š Coverage report may be incomplete due to test failures"
            echo "ðŸ“‹ Test results saved to test-results.json for analysis"
            exit 1
          fi
          
          echo "Tests completed"

      # 8. Generate TSDoc documentation
      - name: Generate TSDoc documentation
        run: |
          echo "Generating TSDoc documentation..."
          npm run docs
          echo "Documentation generated successfully"

      # 9. Create documentation index
      - name: Create documentation index
        run: |
          echo "Creating documentation index..."
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Mosaia Node.js SDK Documentation</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                  .container { max-width: 800px; margin: 0 auto; }
                  h1 { color: #333; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
                  .version { background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 20px 0; }
                  .links { margin: 20px 0; }
                  .links a { display: inline-block; margin: 5px 10px 5px 0; padding: 10px 15px; background: #007acc; color: white; text-decoration: none; border-radius: 5px; }
                  .links a:hover { background: #005a9e; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Mosaia Node.js SDK Documentation</h1>
                  <div class="version">
                      <strong>Version:</strong> ${{ env.version }}
                  </div>
                  <p>Welcome to the Mosaia Node.js SDK documentation. This SDK provides comprehensive access to the Mosaia platform through a unified TypeScript interface.</p>
                  <div class="links">
                      <a href="./modules.html">API Reference</a>
                      <a href="https://github.com/mosaia-development/mosaia-node-sdk">GitHub Repository</a>
                      <a href="https://www.npmjs.com/package/@mosaia/mosaia-node-sdk">NPM Package</a>
                  </div>
                  <p>The documentation is automatically generated from the source code using TypeDoc. For the most up-to-date information, please refer to the GitHub repository.</p>
              </div>
          </body>
          </html>
          EOF
          echo "Documentation index created successfully"

      # 10. Deploy documentation to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/tags/v*'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          force_orphan: true

      # 11. Publish to NPM
      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
